name: Generate Documentation PDFs

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'ARQUITECTURA.md'
      - 'DATABASE-DOMAINS-STRUCTURE.md'
      - 'DIAGRAMAS-SIMPLIFICADOS.md'
      - 'exports/schema.sql'
      - '.github/workflows/generate-pdfs.yml'
  workflow_dispatch: # Permite ejecutar manualmente el workflow

permissions:
  contents: write

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies for Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            chromium-browser \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2t64

      - name: Install markdown-pdf with Mermaid support
        run: |
          npm install -g mdpdf
          npm install -g @mermaid-js/mermaid-cli

      - name: Create exports directory
        run: mkdir -p exports

      - name: Generate PDFs with Mermaid support
        run: |
          echo "Generating ARQUITECTURA.pdf..."
          mdpdf ARQUITECTURA.md exports/ARQUITECTURA.pdf \
            --format=A4 \
            --border=20mm
          echo "âœ“ ARQUITECTURA.pdf created: $(ls -lh exports/ARQUITECTURA.pdf)"

          echo "Generating DATABASE-DOMAINS-STRUCTURE.pdf..."
          mdpdf DATABASE-DOMAINS-STRUCTURE.md exports/DATABASE-DOMAINS-STRUCTURE.pdf \
            --format=A4 \
            --border=20mm
          echo "âœ“ DATABASE-DOMAINS-STRUCTURE.pdf created: $(ls -lh exports/DATABASE-DOMAINS-STRUCTURE.pdf)"

          echo "Generating DIAGRAMAS-SIMPLIFICADOS.pdf..."
          mdpdf DIAGRAMAS-SIMPLIFICADOS.md exports/DIAGRAMAS-SIMPLIFICADOS.pdf \
            --format=A4 \
            --border=20mm
          echo "âœ“ DIAGRAMAS-SIMPLIFICADOS.pdf created: $(ls -lh exports/DIAGRAMAS-SIMPLIFICADOS.pdf)"

          echo ""
          echo "All PDFs in exports/:"
          ls -lh exports/
        continue-on-error: false
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'false'
          PUPPETEER_EXECUTABLE_PATH: '/usr/bin/chromium-browser'

      - name: Commit and push PDFs
        run: |
          echo "Git status before adding:"
          git status

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          echo ""
          echo "Adding PDFs to git..."
          git add exports/*.pdf

          echo ""
          echo "Git status after adding:"
          git status

          echo ""
          echo "Staged changes:"
          git diff --staged --name-only

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo ""
            echo "â„¹ï¸ No changes to commit (PDFs are identical to existing ones)"
          else
            echo ""
            echo "Committing changes..."
            git commit -m "docs: update generated PDFs [skip ci]"

            echo ""
            echo "Pushing to remote..."
            git push

            echo ""
            echo "âœ“ PDFs committed and pushed successfully"
          fi

      - name: Summary
        run: |
          echo "## PDF Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully generated PDFs:" >> $GITHUB_STEP_SUMMARY
          echo "- ARQUITECTURA.pdf" >> $GITHUB_STEP_SUMMARY
          echo "- DATABASE-DOMAINS-STRUCTURE.pdf" >> $GITHUB_STEP_SUMMARY
          echo "- DIAGRAMAS-SIMPLIFICADOS.pdf" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f exports/ARQUITECTURA.pdf ]; then
            echo "ðŸ“„ ARQUITECTURA.pdf size: $(du -h exports/ARQUITECTURA.pdf | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f exports/DATABASE-DOMAINS-STRUCTURE.pdf ]; then
            echo "ðŸ“„ DATABASE-DOMAINS-STRUCTURE.pdf size: $(du -h exports/DATABASE-DOMAINS-STRUCTURE.pdf | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f exports/DIAGRAMAS-SIMPLIFICADOS.pdf ]; then
            echo "ðŸ“„ DIAGRAMAS-SIMPLIFICADOS.pdf size: $(du -h exports/DIAGRAMAS-SIMPLIFICADOS.pdf | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi
